<html>
<head>
  <meta charset="UTF-8">
<style>

        html, body {
            margin: 0px;
            padding: 0px;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: Helvetica;
        }

        #tree {
            width: 100%;
            height: 100%;
        }
        .btn path {
            fill: #dbdbdb;
        }

        .btn:hover path {
            fill: #ffffff;
        }
		
</style>
<script src="getorgchart.js"></script>
    <link href="getorgchart.css" rel="stylesheet" />

<!-- script src="parsec3.js"></script -->
</head>
<body>
<div id="tree"/>
<script>
var btnAdd = '<g class="btn" transform="matrix(0.14,0,0,0.14,100,0)"><rect style="opacity:0" x="0" y="0" height="300" width="300" /><title>[tooltip]</title><path  fill="#686868" d="M149.996,0C67.157,0,0.001,67.158,0.001,149.997c0,82.837,67.156,150,149.995,150s150-67.163,150-150 C299.996,67.156,232.835,0,149.996,0z M149.996,59.147c25.031,0,45.326,20.292,45.326,45.325 c0,25.036-20.292,45.328-45.326,45.328s-45.325-20.292-45.325-45.328C104.671,79.439,124.965,59.147,149.996,59.147z M168.692,212.557h-0.001v16.41v2.028h-18.264h-0.864H83.86c0-44.674,24.302-60.571,40.245-74.843 c7.724,4.15,16.532,6.531,25.892,6.601c9.358-0.07,18.168-2.451,25.887-6.601c7.143,6.393,15.953,13.121,23.511,22.606h-7.275 v10.374v13.051h-13.054h-10.374V212.557z M218.902,228.967v23.425h-16.41v-23.425h-23.428v-16.41h23.428v-23.425H218.9v23.425 h23.423v16.41H218.902z"/></g>';
getOrgChart.themes.ula.box += '<g transform="matrix(1,0,0,1,350,10)">' + btnAdd + '</g>';

var xhttp = window.XMLHttpRequest ? new XMLHttpRequest() : new ActiveXObject("Microsoft.XMLHTTP");
    xhttp.onreadystatechange = function () {
        if (xhttp.readyState === 4 && xhttp.status === 200) {
            makeChart(JSON.parse(xhttp.responseText));
            //result = (xhttp.responseText);
        } else {
            result = {
                error: 'status="' + xhttp.statusText + ' (' + xhttp.status + ')", state="' + xhttp.readyState + '"'
            };
        }
    };
    xhttp.open("GET", "../orgdata.aspx", true);
    xhttp.send();
	
var renderNodeHandle = function(sender, args) {
			var d = args.node.data;
			if(d.tag == "org") return;
			var t = (d.tag == "in") ? ("В офисе - вход: "+d.enter) : 
					  (d.tag == "out") ? ("Вне офиса - вход: "+d.enter +" выход: " +d.exit) : 
					  (d.tag == "absent") ? "Отсутствует" : null;
        	args.content[1] = args.content[1].replace("[tooltip]", t);
}

function getNodeByClickedBtn(el) {
    while (el.parentNode) {
        el = el.parentNode;
        if (el.getAttribute("data-node-id"))
            return el;
    }
    return null;
}

var initBtn = function(){
    var btns = document.getElementsByClassName("btn");
    for (var i = 0; i < btns.length; i++) {
        btns[i].addEventListener("click", function () {                  
            var nodeElement = getNodeByClickedBtn(this);
            var id = nodeElement.getAttribute("data-node-id");
			window.open('hist.html?id='+ id, 'window','width=660,height=360,top=50,left=0,resizable=no,scrollbars=no,toolbar=no,menubar=no,location=no,directories=no,status=no');							
        });
    }
}
	
var config = {
	theme: "ula",
	gridView: false,
	maxDepth: 100,
	expandToLevel: 2,
	linkType: "B",
    enableEdit: false,
    enableDetailsView: false,
    primaryFields: ["name", "title", "mob", "corp"],
    photoFields: ["img"],	
	searchFields: ["name"],
    layout: getOrgChart.MIXED_HIERARCHY_RIGHT_LINKS,
//    dataSource: {},
//	customize: {},
    renderNodeEvent: renderNodeHandle,
    updatedEvent: initBtn

};
function makeChart(cdata) {
		var c = {}, d;
		for(var i=0; i<cdata.length; i++){
			d = cdata[i];
			c[d.id] = (d.tag == "org") ? {theme: "ola"} : 
					  (d.tag == "in") ? {color : "lightgreen"} : 
					  (d.tag == "out") ? {color : "orange"} : 
					  (d.tag == "absent") ? {color : "lightteal"} : null;
		}
		config.customize = c;
        config.dataSource = cdata;
        var chart = new getOrgChart(document.getElementById("tree"), config);
		initBtn();
}	
	

</script>
</body>
</html>